<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Graphic Design Production Planner 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Changed Font to Kanit -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Light Blue Theme Body with Kanit Font */
        body { font-family: 'Kanit', sans-serif; background-color: #f0f9ff; color: #334155; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Channel Colors */
        .border-l-platform { border-left: 4px solid #3b82f6; } /* Blue */
        .border-l-social { border-left: 4px solid #ec4899; } /* Pink */
        .border-l-internal { border-left: 4px solid #06b6d4; } /* Cyan */
        .border-l-offline { border-left: 4px solid #f97316; } /* Orange for Offline Sale */

        /* Status Badges */
        .status-todo { background-color: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .status-doing { background-color: #eff6ff; color: #3b82f6; border: 1px solid #dbeafe; }
        .status-draft { background-color: #f5f3ff; color: #8b5cf6; border: 1px solid #ede9fe; }
        .status-done { background-color: #ecfdf5; color: #10b981; border: 1px solid #d1fae5; }

        /* Priority Colors */
        .priority-C { background-color: #fef2f2; color: #ef4444; border: 1px solid #fee2e2; }
        .priority-S { background-color: #f0f9ff; color: #0ea5e9; border: 1px solid #e0f2fe; }

        /* Active State - Blue Theme */
        .nav-btn.active { background-color: #0ea5e9; color: white; font-weight: 500; box-shadow: 0 4px 6px -1px rgba(14, 165, 233, 0.3); }
        .tab-active { border-bottom: 2px solid #0ea5e9; color: #0ea5e9; }

        /* Modal Backdrop */
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Navbar -->
    <nav class="bg-white shadow-sm sticky top-0 z-30 border-b border-gray-100">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <!-- LOGO SECTION: Replace src with your logo URL -->
                <img src="https://placehold.co/100x100/0ea5e9/ffffff?text=Logo" alt="Company Logo" class="w-10 h-10 rounded-lg shadow-md shadow-sky-200 object-cover">
                
                <div>
                    <h1 class="text-lg font-bold leading-tight text-slate-800">Graphic Planner 2025</h1>
                    <p class="text-xs text-slate-500 font-light">Shift-Left Production</p>
                </div>
            </div>
            
            <!-- View Switcher Tabs -->
            <div class="flex space-x-6">
                <button onclick="switchView('planner')" id="tab-planner" class="text-sm font-medium py-5 border-b-2 border-transparent hover:text-sky-600 transition tab-active">
                    <i class="fa-solid fa-calendar-days mr-2"></i>Production Planner
                </button>
                <button onclick="switchView('dashboard')" id="tab-dashboard" class="text-sm font-medium py-5 border-b-2 border-transparent hover:text-sky-600 transition">
                    <i class="fa-solid fa-chart-pie mr-2"></i>Status Monitor
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow max-w-7xl mx-auto px-4 py-6 w-full">

        <!-- VIEW 1: PLANNER -->
        <div id="view-planner" class="grid grid-cols-1 lg:grid-cols-12 gap-6 fade-in">
            <!-- Sidebar -->
            <aside class="lg:col-span-3 space-y-4">
                <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-100">
                    <div class="flex justify-between items-center mb-3 pb-2 border-b border-slate-100">
                        <span class="text-xs font-bold text-slate-500 uppercase">Select Month</span>
                        <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded text-slate-500">Task Count</span>
                    </div>
                    <div class="space-y-1" id="monthNavigator"></div>
                </div>
                
                <!-- Quick Legend -->
                <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-100 text-xs space-y-2 font-light">
                    <h4 class="font-medium text-slate-700 mb-2">สถานะงาน (Status)</h4>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-slate-200"></div> ยังไม่เริ่ม (To Do)</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-blue-400"></div> กำลังทำ (In Progress)</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-purple-400"></div> ร่าง/ตั้งเวลา (Draft)</div>
                    <div class="flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-green-400"></div> เสร็จแล้ว (Done)</div>
                </div>
            </aside>

            <!-- Task Area -->
            <section class="lg:col-span-9 space-y-6">
                <!-- Header Card -->
                <div class="bg-gradient-to-r from-sky-500 to-blue-600 text-white rounded-xl p-6 shadow-lg shadow-sky-200 flex justify-between items-center relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-baseline gap-3">
                            <span class="text-sm opacity-80 font-light">Working In:</span>
                            <h2 class="text-3xl font-bold" id="currentMonthTitle">January</h2>
                        </div>
                        <div class="flex items-baseline gap-3 mt-1">
                            <span class="text-sm text-sky-100 font-light">Launching For:</span>
                            <h2 class="text-xl font-semibold text-white" id="launchMonthTitle">February</h2>
                        </div>
                    </div>
                    <div class="relative z-10 text-right hidden sm:block">
                        <div class="text-sm opacity-90 mb-1 font-light">Highlight Campaign</div>
                        <div class="bg-white/20 px-4 py-2 rounded-lg backdrop-blur-sm border border-white/30">
                            <span id="monthThemeDesc" class="font-medium">Valentine's & 2.2 Sale</span>
                        </div>
                    </div>
                    <i class="fa-solid fa-calendar-check absolute -right-6 -bottom-6 text-9xl text-white opacity-10"></i>
                </div>

                <!-- Filters & Add Button -->
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex gap-2 flex-wrap">
                        <button class="px-3 py-1.5 text-sm rounded-lg bg-sky-600 text-white shadow-sm shadow-sky-200 font-medium transition" onclick="filterTasks('all', this)">ทั้งหมด</button>
                        <button class="px-3 py-1.5 text-sm rounded-lg bg-white text-slate-600 border border-slate-200 hover:bg-sky-50 hover:text-sky-600 transition" onclick="filterTasks('Online Platform', this)">Online Platform</button>
                        <button class="px-3 py-1.5 text-sm rounded-lg bg-white text-slate-600 border border-slate-200 hover:bg-sky-50 hover:text-sky-600 transition" onclick="filterTasks('Social Media', this)">Social Media</button>
                        <button class="px-3 py-1.5 text-sm rounded-lg bg-white text-slate-600 border border-slate-200 hover:bg-orange-50 hover:text-orange-600 transition" onclick="filterTasks('Offline Sale', this)">Offline Sale</button>
                        <button class="px-3 py-1.5 text-sm rounded-lg bg-white text-slate-600 border border-slate-200 hover:bg-sky-50 hover:text-sky-600 transition" onclick="filterTasks('Internal/Support', this)">Support</button>
                    </div>
                    
                    <!-- Add Task Button -->
                    <button onclick="openAddTaskModal()" class="flex items-center gap-2 px-4 py-1.5 text-sm font-medium text-white bg-green-500 hover:bg-green-600 rounded-lg shadow-sm shadow-green-200 transition transform active:scale-95">
                        <i class="fa-solid fa-plus"></i> เพิ่มงานใหม่
                    </button>
                </div>

                <!-- Task Grid -->
                <div id="taskList" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Cards will be injected here -->
                </div>
            </section>
        </div>

        <!-- VIEW 2: DASHBOARD (Status Monitor) -->
        <div id="view-dashboard" class="hidden fade-in space-y-6">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Summary Card -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 col-span-2">
                    <h3 class="font-bold text-slate-800 mb-4 text-lg">ภาพรวมงานตลอดปี (Yearly Overview)</h3>
                    <div class="h-64">
                        <canvas id="yearlyChart"></canvas>
                    </div>
                </div>
                <!-- Stats Card -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 space-y-6">
                    <h3 class="font-bold text-slate-800 text-lg">สถานะปัจจุบัน (Current Status)</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-slate-50 rounded-lg border border-slate-100">
                            <span class="text-slate-600"><i class="fa-solid fa-circle text-slate-400 mr-2"></i>To Do</span>
                            <span class="font-bold text-lg text-slate-700" id="stat-todo">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg border border-blue-100">
                            <span class="text-blue-700"><i class="fa-solid fa-spinner text-blue-500 mr-2"></i>In Progress</span>
                            <span class="font-bold text-lg text-blue-700" id="stat-doing">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg border border-purple-100">
                            <span class="text-purple-700"><i class="fa-solid fa-clock text-purple-500 mr-2"></i>Draft/Sched</span>
                            <span class="font-bold text-lg text-purple-700" id="stat-draft">0</span>
                        </div>
                        <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-100">
                            <span class="text-green-700"><i class="fa-solid fa-check-circle text-green-500 mr-2"></i>Completed</span>
                            <span class="font-bold text-lg text-green-700" id="stat-done">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-sky-50/50">
                    <div>
                        <h3 class="font-bold text-slate-700">รายละเอียดความคืบหน้า (Monthly Breakdown)</h3>
                        <p class="text-xs text-slate-400 mt-1 font-light">คลิกที่เดือนเพื่อดูรายละเอียดงาน</p>
                    </div>
                    <span class="text-xs text-slate-400 font-light">*นับตามจำนวนงาน</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-100">
                            <tr>
                                <th class="px-6 py-3 w-1/4">เดือน</th>
                                <th class="px-6 py-3">งานทั้งหมด</th>
                                <th class="px-6 py-3 w-1/3">ความคืบหน้า</th>
                                <th class="px-6 py-3">%</th>
                                <th class="px-6 py-3 text-right">สถานะภาพรวม</th>
                            </tr>
                        </thead>
                        <tbody id="dashboardTableBody" class="divide-y divide-slate-100 font-light">
                            <!-- Rows injected JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ADD TASK MODAL -->
        <div id="addTaskModal" class="fixed inset-0 z-50 hidden flex items-center justify-center modal-backdrop fade-in">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 overflow-hidden border border-slate-100">
                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                    <h3 class="font-bold text-lg text-slate-800"><i class="fa-solid fa-pen-to-square text-sky-500 mr-2"></i>เพิ่มงานใหม่ (Add Task)</h3>
                    <button onclick="closeAddTaskModal()" class="text-slate-400 hover:text-red-500 transition">
                        <i class="fa-solid fa-xmark text-xl"></i>
                    </button>
                </div>
                <div class="p-6 space-y-4">
                    <!-- Form -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ชื่องาน (Task Title)</label>
                        <input type="text" id="newTaskTitle" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition" placeholder="เช่น Banner: 3.3 Sale">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">รายละเอียด (Description)</label>
                        <textarea id="newTaskDesc" rows="2" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition" placeholder="รายละเอียดงาน..."></textarea>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ช่องทาง (Channel)</label>
                            <select id="newTaskChannel" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white">
                                <option value="Online Platform">Online Platform</option>
                                <option value="Social Media">Social Media</option>
                                <option value="Offline Sale">Offline Sale</option> <!-- NEW -->
                                <option value="Internal/Support">Internal/Support</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ความสำคัญ (Priority)</label>
                            <select id="newTaskPriority" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white">
                                <option value="C">Critical (C)</option>
                                <option value="S">Support (S)</option>
                            </select>
                        </div>
                    </div>
                    <div>
                         <label class="block text-xs font-bold text-slate-500 uppercase mb-1">ธีมงาน (Theme)</label>
                         <input type="text" id="newTaskTheme" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 transition" placeholder="เช่น Summer Sale">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">KPI Reference</label>
                        <select id="newTaskKPI" class="w-full border border-slate-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500 bg-white">
                            <option value="Financials (1.1)">Financials (1.1)</option>
                            <option value="Profitability (1.2)">Profitability (1.2)</option>
                            <option value="Budget (1.3)">Budget (1.3)</option>
                            <option value="Financials (1.4)">Financials (1.4)</option>
                            <option value="Financials (1.5)">Financials (1.5)</option>
                            <option value="Financials (1.6)">Financials (1.6)</option>
                            <option value="Financials (1.7)">Financials (1.7)</option>
                            <option value="Customer & Strategy (2.1)">Customer & Strategy (2.1)</option>
                            <option value="Customer & Strategy (2.2)">Customer & Strategy (2.2)</option>
                            <option value="Customer & Strategy (2.3)">Customer & Strategy (2.3)</option>
                            <option value="Risk & Compliance (5.1)">Risk & Compliance (5.1)</option>
                            <option value="Compliance (5.3)">Compliance (5.3)</option>
                            <option value="Cross-BU (6.1)">Cross-BU (6.1)</option>
                            <option value="Strategy (6.5)">Strategy (6.5)</option>
                        </select>
                    </div>
                </div>
                <div class="px-6 py-4 bg-slate-50 border-t border-slate-100 flex justify-end gap-2">
                    <button onclick="closeAddTaskModal()" class="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg transition">ยกเลิก</button>
                    <button onclick="saveNewTask()" class="px-4 py-2 text-sm font-medium text-white bg-sky-500 hover:bg-sky-600 rounded-lg shadow-sm shadow-sky-200 transition">บันทึกงาน</button>
                </div>
            </div>
        </div>

    </main>

    <!-- Logic -->
    <script>
        // --- 1. Data Setup ---
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const fullMonths = ["มกราคม (Jan)", "กุมภาพันธ์ (Feb)", "มีนาคม (Mar)", "เมษายน (Apr)", "พฤษภาคม (May)", "มิถุนายน (Jun)", "กรกฎาคม (Jul)", "สิงหาคม (Aug)", "กันยายน (Sep)", "ตุลาคม (Oct)", "พฤศจิกายน (Nov)", "ธันวาคม (Dec)"];
        const launchMonths = ["กุมภาพันธ์ (Feb)", "มีนาคม (Mar)", "เมษายน (Apr)", "พฤษภาคม (May)", "มิถุนายน (Jun)", "กรกฎาคม (Jul)", "สิงหาคม (Aug)", "กันยายน (Sep)", "ตุลาคม (Oct)", "พฤศจิกายน (Nov)", "ธันวาคม (Dec)", "มกราคม (Jan ปีหน้า)"];

        const themeDB = {
            1: { double: "New Year New You", mid: "Start Fresh Deals", payday: "Payday รับตรุษจีน" },
            2: { double: "Double Love Deal", mid: "Sweet Valentine", payday: "Payday คนมีคู่" },
            3: { double: "Summer Hot Sale", mid: "Hot Deal ท้าแดด", payday: "Payday คลายร้อน" },
            4: { double: "Songkran Mega Sale", mid: "สาดโปร ชุ่มฉ่ำ", payday: "Payday หลังสงกรานต์" },
            5: { double: "Back to School", mid: "Rainy Season Prep", payday: "Payday ท้าฝน" },
            6: { double: "Mid-Year Mega Sale", mid: "Mid-Year Bonus", payday: "Payday ช้อปกลางปี" },
            7: { double: "Healthy July", mid: "Health Boost Deal", payday: "Payday สุขภาพดี" },
            8: { double: "Mother's Day Special", mid: "Love Mom Deal", payday: "Payday เพื่อแม่" },
            9: { double: "9.9 Super Shopping", mid: "After Party 9.9", payday: "Payday ปลายฝน" },
            10: { double: "10.10 Brand Festival", mid: "Big Brands Sale", payday: "Payday เตรียมหนาว" },
            11: { double: "11.11 Biggest Sale", mid: "Shock Price Deal", payday: "Payday ก่อนปีใหม่" },
            12: { double: "12.12 Year End Sale", mid: "Gift Festival", payday: "Payday ฉลองปีใหม่" }
        };

        let scheduleData = [];

        function getOnlineTasks(targetMonthNum, targetMonthName) {
            const doubleDigit = `${targetMonthNum}.${targetMonthNum}`; 
            const themes = themeDB[targetMonthNum];
            return [
                { title: `Banner: ${doubleDigit} Double Digit`, desc: `ภาพหลักแคมเปญ ${doubleDigit} (Hero Banner, Frame, Template)`, channel: "Online Platform", eventTag: "Double Digit", campaignTheme: themes.double, kpi: "Financials (1.1)", priority: "C", status: "todo" },
                { title: `Banner: Mid-Month Sale ${targetMonthName}`, desc: "ภาพโปรโมชั่นกลางเดือน (วันที่ 15) เน้นสินค้าขายดี", channel: "Online Platform", eventTag: "Mid-Month", campaignTheme: themes.mid, kpi: "Financials (1.1)", priority: "C", status: "todo" },
                { title: `Banner: Payday Sale ${targetMonthName}`, desc: "ภาพโปรโมชั่นสิ้นเดือน (เงินเดือนออก) เน้นจัดเซตคุ้มค่า", channel: "Online Platform", eventTag: "Payday", campaignTheme: themes.payday, kpi: "Financials (1.1)", priority: "C", status: "todo" }
            ];
        }

        const socialThemes = [
            // Jan
            [{ title: "Content: Valentine's Day", desc: "รูปคู่รัก/ของขวัญ (Mask/Spray) ลง FB/IG", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Love & Care", priority: "C", status: "todo" },
             { title: "Review: Mask for PM2.5", desc: "รวมรีวิวลูกค้าเรื่องกันฝุ่น", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Healthy Lungs", priority: "S", status: "todo" },
             { title: "Internal: Q1 Newsletter", desc: "จดหมายข่าวอัปเดตกิจกรรมภายใน Q1", channel: "Internal/Support", kpi: "Internal Collaboration (6.5)", campaignTheme: "Corp Comm", priority: "S", status: "todo" }],
            // Feb
            [{ title: "Content: Summer & Hygiene", desc: "การดูแลความสะอาดหน้าร้อน", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Summer Guard", priority: "S", status: "todo" },
             { title: "Review: Air Purifier", desc: "รีวิวเครื่องฟอกอากาศรับหน้าร้อน", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Clean Air", priority: "C", status: "todo" }],
            // Mar
            [{ title: "Content: Songkran Greeting", desc: "สวัสดีปีใหม่ไทย & แจ้งวันหยุด", channel: "Social Media", kpi: "Strategy (6.5)", campaignTheme: "Thai New Year", priority: "S", status: "todo" },
             { title: "Promotion: Big Cleaning", desc: "โปรโมชั่นทำความสะอาดบ้านก่อนหยุดยาว", channel: "Social Media", kpi: "Financials (1.1)", campaignTheme: "Big Cleaning", priority: "C", status: "todo" },
             { title: "Poster: Safety First", desc: "โปสเตอร์รณรงค์ความปลอดภัยช่วงสงกรานต์", channel: "Internal/Support", kpi: "Compliance (5.3)", campaignTheme: "Safety Awareness", priority: "S", status: "todo" },
             { title: "Survey: Customer Satisfaction", desc: "แบบสอบถามความพึงพอใจลูกค้าประจำไตรมาส", channel: "Social Media", kpi: "Customer & Strategy (2.1)", campaignTheme: "Customer Care", priority: "S", status: "todo" }],
            // Apr
            [{ title: "Content: Back to School/Work", desc: "เตรียมพร้อมกลับมาทำงาน/เรียน", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Safe Return", priority: "S", status: "todo" },
             { title: "Product: New Spray Look", desc: "เปิดตัวแพ็กเกจใหม่สเปรย์", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "New Arrival", priority: "C", status: "todo" },
             { title: "Doc: Price List Update", desc: "อัปเดตใบราคาใหม่สำหรับฝ่ายขาย", channel: "Internal/Support", kpi: "Budget (1.3)", campaignTheme: "Sales Tool", priority: "S", status: "todo" }],
            // May
            [{ title: "Content: Rainy Season Tips", desc: "ระวังโรคหน้าฝนและการป้องกัน", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Rainy Shield", priority: "S", status: "todo" },
             { title: "Review: All-purpose Cleaner", desc: "วิดีโอสั้นขจัดคราบน้ำฝน/โคลน", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Easy Clean", priority: "C", status: "todo" }],
            // Jun
            [{ title: "Content: Health Habits", desc: "5 นิสัยสุขภาพดีห่างไกลโรค", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Healthy Habits", priority: "S", status: "todo" },
             { title: "Catalog: Q3 Update", desc: "อัปเดตแคตตาล็อกสินค้าครึ่งปีหลัง", channel: "Internal/Support", kpi: "Budget (1.3)", campaignTheme: "Q3 Collection", priority: "S", status: "todo" }],
            // Jul
            [{ title: "Content: Mother's Day", desc: "บอกรักแม่ด้วยสุขภาพ (Gift Idea)", channel: "Social Media", kpi: "Financials (1.1)", campaignTheme: "Love Mom", priority: "C", status: "todo" },
             { title: "Activity: Photo Contest", desc: "กิจกรรมประกวดภาพถ่ายคู่แม่ลูก", channel: "Social Media", kpi: "Strategy (6.1)", campaignTheme: "Mom & Me", priority: "S", status: "todo" },
             { title: "Event: Team Building", desc: "ออกแบบเสื้อ/ป้ายงาน Team Building", channel: "Internal/Support", kpi: "Cross-BU (6.1)", campaignTheme: "Synergy", priority: "S", status: "todo" }],
            // Aug
            [{ title: "Content: 9.9 Teaser", desc: "นับถอยหลังโปรโมชั่น 9.9", channel: "Social Media", kpi: "Financials (1.1)", campaignTheme: "9.9 Countdown", priority: "C", status: "todo" },
             { title: "Product: Flash Sale Alert", desc: "เทมเพลตแจ้งเตือน Flash Sale", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Urgent Deal", priority: "C", status: "todo" }],
            // Sep
            [{ title: "Content: End of Rain", desc: "ดูแลบ้านช่วงปลายฝนต้นหนาว", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Season Change", priority: "S", status: "todo" },
             { title: "CSR: Community Help", desc: "ภาพข่าวกิจกรรม CSR บริษัท", channel: "Internal/Support", kpi: "Strategy (6.1)", campaignTheme: "Giving Back", priority: "S", status: "todo" }],
            // Oct
            [{ title: "Content: 11.11 Warm up", desc: "เตรียมตัวช้อป 11.11 (Wishlist)", channel: "Social Media", kpi: "Financials (1.1)", campaignTheme: "11.11 Wishlist", priority: "C", status: "todo" },
             { title: "Product: Air Purifier Features", desc: "จุดเด่นเครื่องฟอก (รับหน้าหนาว)", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "Pure Air", priority: "S", status: "todo" }],
            // Nov
            [{ title: "Content: Year End Thank You", desc: "ขอบคุณลูกค้า & สรุปปี", channel: "Social Media", kpi: "Strategy (6.1)", campaignTheme: "Thank You", priority: "S", status: "todo" },
             { title: "Promotion: Gift Sets", desc: "รวมไอเดียของขวัญปีใหม่", channel: "Social Media", kpi: "Financials (1.1)", campaignTheme: "Gift of Health", priority: "C", status: "todo" }],
            // Dec
            [{ title: "Content: PM2.5 Warning", desc: "เตือนภัยฝุ่น & การใส่หน้ากาก", channel: "Social Media", kpi: "Profitability (1.2)", campaignTheme: "PM2.5 Alert", priority: "S", status: "todo" },
             { title: "Plan: Next Year Key Visual", desc: "ออกแบบธีมบริษัทปีหน้า", channel: "Internal/Support", kpi: "Strategy (6.5)", campaignTheme: "Next Gen", priority: "S", status: "todo" }]
        ];

        // Init Data
        for (let i = 0; i < 12; i++) {
            let targetNum = i + 2; if (targetNum > 12) targetNum = 1;
            const targetName = launchMonths[i].split(' ')[0];
            const online = getOnlineTasks(targetNum, targetName);
            const social = socialThemes[i] || [];
            
            // Auto-Generate Offline Sale Catalog every 3 months (Jan, Apr, Jul, Oct)
            const offline = [];
            if (i % 3 === 0) {
                 offline.push({
                    title: "Catalog Update: Quarterly",
                    desc: "อัปเดตเล่มแคตตาล็อกสินค้าและโปรโมชั่นสำหรับทีมขาย Offline",
                    channel: "Offline Sale",
                    eventTag: "Quarterly",
                    campaignTheme: "Sales Tools",
                    kpi: "Budget (1.3)",
                    priority: "S",
                    status: "todo"
                });
            }

            scheduleData.push([...online, ...social, ...offline]);
        }

        // --- 2. State & DOM ---
        let currentMonth = 0;
        let activeFilter = 'all';
        let chartInstance = null;
        let openDropdownId = null;

        const STATUS_CONFIG = {
            'todo': { label: 'ยังไม่เริ่ม', colorClass: 'status-todo', icon: 'fa-circle' },
            'doing': { label: 'กำลังดำเนินงาน', colorClass: 'status-doing', icon: 'fa-spinner fa-spin' },
            'draft': { label: 'ร่าง/ตั้งเวลา', colorClass: 'status-draft', icon: 'fa-clock' },
            'done': { label: 'เสร็จแล้ว', colorClass: 'status-done', icon: 'fa-check-circle' }
        };

        function switchView(viewName) {
            document.getElementById('view-planner').classList.add('hidden');
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('tab-planner').classList.remove('tab-active');
            document.getElementById('tab-dashboard').classList.remove('tab-active');

            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            document.getElementById(`tab-${viewName}`).classList.add('tab-active');

            if(viewName === 'dashboard') renderDashboard();
        }

        function loadMonth(idx) {
            currentMonth = idx;
            document.querySelectorAll('.nav-btn').forEach((b, i) => {
                b.className = i===idx 
                    ? "nav-btn active w-full text-left px-3 py-2 rounded-lg flex justify-between items-center text-sm shadow-md transition-all" 
                    : "nav-btn w-full text-left px-3 py-2 rounded-lg flex justify-between items-center text-sm text-slate-600 hover:bg-white hover:text-sky-600 transition-all";
            });
            
            document.getElementById('currentMonthTitle').innerText = fullMonths[idx].split(' ')[0];
            document.getElementById('launchMonthTitle').innerText = launchMonths[idx];
            
            const doubleDigit = idx === 11 ? "1.1" : `${idx+2}.${idx+2}`;
            document.getElementById('monthThemeDesc').innerText = `Prep for ${doubleDigit} & ${socialThemes[idx][0]?.title ? socialThemes[idx][0].title.split(':')[1] : 'General'}`;

            renderTasks();
        }

        function toggleStatusDropdown(event, dropdownId) {
            event.stopPropagation(); // Prevent bubbling to document
            const dropdown = document.getElementById(dropdownId);
            
            // Close current if different
            if (openDropdownId && openDropdownId !== dropdownId) {
                document.getElementById(openDropdownId)?.classList.add('hidden');
            }

            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                openDropdownId = dropdownId;
            } else {
                dropdown.classList.add('hidden');
                openDropdownId = null;
            }
        }

        // Close dropdowns when clicking anywhere else
        document.addEventListener('click', function(event) {
            if (openDropdownId) {
                const dropdown = document.getElementById(openDropdownId);
                if (dropdown && !dropdown.contains(event.target)) {
                    dropdown.classList.add('hidden');
                    openDropdownId = null;
                }
            }
        });

        function updateTaskStatus(monthIdx, taskIdx, newStatus) {
            scheduleData[monthIdx][taskIdx].status = newStatus;
            renderTasks(); 
            if(!document.getElementById('view-dashboard').classList.contains('hidden')) renderDashboard();
        }

        function renderTasks() {
            const data = scheduleData[currentMonth];
            const container = document.getElementById('taskList');
            container.innerHTML = "";

            const filtered = activeFilter === 'all' ? data : data.filter(t => t.channel === activeFilter);

            if(filtered.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-10 text-slate-400 font-light">ยังไม่มีงานในหมวดหมู่นี้</div>`;
                return;
            }

            filtered.forEach((task, idx) => {
                const masterIdx = data.indexOf(task);
                let borderClass = 'border-l-internal';
                let icon = 'fa-file';
                if(task.channel === 'Online Platform') { borderClass = 'border-l-platform'; icon = 'fa-shop'; }
                else if(task.channel === 'Social Media') { borderClass = 'border-l-social'; icon = 'fa-hashtag'; }
                else if(task.channel === 'Offline Sale') { borderClass = 'border-l-offline'; icon = 'fa-book-open'; }

                const priorityClass = task.priority === 'C' ? 'priority-C' : 'priority-S';
                const sConf = STATUS_CONFIG[task.status];

                const dropdownId = `status-dropdown-${idx}`;

                const div = document.createElement('div');
                div.className = `bg-white p-5 rounded-xl shadow-sm border border-slate-100 ${borderClass} fade-in relative hover:shadow-md transition`;
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <div class="flex items-center gap-2">
                            <i class="fa-solid ${icon} text-slate-400"></i>
                            <span class="text-xs font-bold uppercase text-slate-400 tracking-wide">${task.channel}</span>
                            ${task.eventTag ? `<span class="text-[10px] bg-sky-50 text-sky-600 px-2 py-0.5 rounded-full font-bold">${task.eventTag}</span>` : ''}
                        </div>
                        <span class="text-[10px] px-2 py-0.5 rounded font-bold ${priorityClass}">Priority ${task.priority}</span>
                    </div>

                    <h4 class="font-bold text-slate-800 text-lg mb-1 leading-snug">${task.title.split(':')[1] || task.title}</h4>
                    <p class="text-xs text-slate-500 mb-2 font-medium"><i class="fa-solid fa-paintbrush mr-1"></i>Theme: ${task.campaignTheme || '-'}</p>
                    <p class="text-sm text-slate-600 mb-4 line-clamp-2 h-10 font-light">${task.desc}</p>

                    <div class="pt-3 border-t border-slate-100 flex justify-between items-center">
                        <div class="relative">
                            <button onclick="toggleStatusDropdown(event, '${dropdownId}')" class="flex items-center gap-2 text-xs font-bold px-3 py-1.5 rounded-full transition ${sConf.colorClass}">
                                <i class="fa-solid ${sConf.icon}"></i> ${sConf.label} <i class="fa-solid fa-chevron-down opacity-50 ml-1"></i>
                            </button>
                            <div id="${dropdownId}" class="absolute bottom-full left-0 mb-2 w-40 bg-white shadow-xl rounded-lg border border-slate-100 hidden z-20 overflow-hidden">
                                <div class="p-1">
                                    <div onclick="updateTaskStatus(${currentMonth}, ${masterIdx}, 'todo')" class="cursor-pointer px-3 py-2 text-xs hover:bg-slate-50 text-slate-600 flex items-center gap-2"><div class="w-2 h-2 bg-slate-300 rounded-full"></div> ยังไม่เริ่ม</div>
                                    <div onclick="updateTaskStatus(${currentMonth}, ${masterIdx}, 'doing')" class="cursor-pointer px-3 py-2 text-xs hover:bg-blue-50 text-blue-600 flex items-center gap-2"><div class="w-2 h-2 bg-blue-500 rounded-full"></div> กำลังทำ</div>
                                    <div onclick="updateTaskStatus(${currentMonth}, ${masterIdx}, 'draft')" class="cursor-pointer px-3 py-2 text-xs hover:bg-purple-50 text-purple-600 flex items-center gap-2"><div class="w-2 h-2 bg-purple-500 rounded-full"></div> ร่าง/ตั้งเวลา</div>
                                    <div onclick="updateTaskStatus(${currentMonth}, ${masterIdx}, 'done')" class="cursor-pointer px-3 py-2 text-xs hover:bg-green-50 text-green-600 flex items-center gap-2"><div class="w-2 h-2 bg-green-500 rounded-full"></div> เสร็จแล้ว</div>
                                </div>
                            </div>
                        </div>
                        <span class="text-[10px] text-slate-400 font-light">KPI: ${task.kpi}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function filterTasks(f, btn) {
            activeFilter = f;
            btn.parentElement.querySelectorAll('button').forEach(b => b.className = "px-3 py-1.5 text-sm rounded-lg bg-white text-slate-600 border border-slate-200 hover:bg-sky-50 hover:text-sky-600 transition");
            // Highlight Offline Sale differently (Orange) if selected
            if(f === 'Offline Sale') {
                btn.className = "px-3 py-1.5 text-sm rounded-lg bg-orange-500 text-white shadow-sm shadow-orange-200 font-medium";
            } else {
                btn.className = "px-3 py-1.5 text-sm rounded-lg bg-sky-600 text-white shadow-sm shadow-sky-200 font-medium";
            }
            renderTasks();
        }

        // --- Dashboard Logic ---
        function toggleMonthDetails(idx) {
            const row = document.getElementById(`details-${idx}`);
            const chevron = document.getElementById(`chevron-${idx}`);
            if(row.classList.contains('hidden')) {
                row.classList.remove('hidden');
                chevron.classList.add('rotate-90');
            } else {
                row.classList.add('hidden');
                chevron.classList.remove('rotate-90');
            }
        }

        function renderDashboard() {
            let counts = { todo:0, doing:0, draft:0, done:0 };
            let monthlyProgress = [];

            scheduleData.forEach((monthTasks, idx) => {
                let mDone = 0;
                monthTasks.forEach(t => {
                    counts[t.status]++;
                    if(t.status === 'done') mDone++;
                });
                let percent = monthTasks.length > 0 ? Math.round((mDone / monthTasks.length) * 100) : 0;
                monthlyProgress.push(percent);
            });

            document.getElementById('stat-todo').innerText = counts.todo;
            document.getElementById('stat-doing').innerText = counts.doing;
            document.getElementById('stat-draft').innerText = counts.draft;
            document.getElementById('stat-done').innerText = counts.done;

            const tbody = document.getElementById('dashboardTableBody');
            tbody.innerHTML = months.map((m, i) => {
                const total = scheduleData[i].length;
                const done = scheduleData[i].filter(t => t.status === 'done').length;
                const pct = total > 0 ? Math.round((done/total)*100) : 0;
                let barColor = 'bg-slate-200';
                if(pct > 0) barColor = 'bg-blue-500';
                if(pct === 100) barColor = 'bg-green-500';

                const tasks = scheduleData[i];
                const taskRows = tasks.map(t => {
                    const sConf = STATUS_CONFIG[t.status];
                    return `
                        <div class="flex justify-between items-center p-2.5 hover:bg-white rounded-lg border border-transparent hover:border-slate-200 transition mb-1 last:mb-0">
                            <div class="flex items-center gap-3">
                                <span class="text-[10px] font-bold uppercase text-slate-400 w-16">${t.channel.split(' ')[0]}</span>
                                <span class="text-sm font-medium text-slate-700 truncate max-w-[200px] sm:max-w-xs">${t.title}</span>
                            </div>
                            <span class="text-[10px] px-2 py-0.5 rounded-full ${sConf.colorClass} border flex items-center gap-1 whitespace-nowrap">
                                <i class="fa-solid ${sConf.icon}"></i> ${sConf.label}
                            </span>
                        </div>
                    `;
                }).join('');

                return `
                    <tr class="bg-white border-b border-slate-50 hover:bg-sky-50 cursor-pointer transition-colors" onclick="toggleMonthDetails(${i})">
                        <td class="px-6 py-4 font-medium text-slate-900 flex items-center gap-3">
                            <i id="chevron-${i}" class="fa-solid fa-chevron-right text-slate-400 text-xs transition-transform duration-200"></i>
                            ${m}
                        </td>
                        <td class="px-6 py-4 text-slate-600">${total}</td>
                        <td class="px-6 py-4">
                            <div class="w-full bg-slate-200 rounded-full h-2.5">
                                <div class="${barColor} h-2.5 rounded-full transition-all duration-500" style="width: ${pct}%"></div>
                            </div>
                        </td>
                        <td class="px-6 py-4 font-bold text-slate-700">${pct}%</td>
                        <td class="px-6 py-4 text-right">
                            ${pct === 100 ? '<span class="text-green-600 text-xs font-bold"><i class="fa-solid fa-check mr-1"></i>Completed</span>' : 
                              pct > 0 ? '<span class="text-blue-600 text-xs font-bold">In Progress</span>' : 
                              '<span class="text-slate-400 text-xs">Not Started</span>'}
                        </td>
                    </tr>
                    <tr id="details-${i}" class="hidden bg-slate-50/50">
                        <td colspan="5" class="px-6 py-4">
                            <div class="pl-6 border-l-2 border-slate-200 space-y-1">
                                ${tasks.length ? taskRows : '<p class="text-sm text-slate-400 italic pl-2">No tasks assigned.</p>'}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            const ctx = document.getElementById('yearlyChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: '% Completion',
                        data: monthlyProgress,
                        backgroundColor: monthlyProgress.map(p => p === 100 ? '#10b981' : '#0ea5e9'),
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- Add Task Logic ---
        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('hidden');
        }

        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('hidden');
            // Reset form
            document.getElementById('newTaskTitle').value = '';
            document.getElementById('newTaskDesc').value = '';
            document.getElementById('newTaskTheme').value = '';
        }

        function saveNewTask() {
            const title = document.getElementById('newTaskTitle').value;
            const desc = document.getElementById('newTaskDesc').value;
            const channel = document.getElementById('newTaskChannel').value;
            const priority = document.getElementById('newTaskPriority').value;
            const theme = document.getElementById('newTaskTheme').value;
            const kpi = document.getElementById('newTaskKPI').value;

            if(!title) {
                alert("กรุณากรอกชื่องาน");
                return;
            }

            const newTask = {
                title: title,
                desc: desc || "No description",
                channel: channel,
                priority: priority,
                campaignTheme: theme || "General",
                kpi: kpi,
                status: "todo",
                eventTag: null // Simple default
            };

            // Add to current month's data
            scheduleData[currentMonth].push(newTask);
            
            // Refresh View
            loadMonth(currentMonth); // Updates Sidebar count and Task List
            closeAddTaskModal();
        }

        // --- Init ---
        document.getElementById('monthNavigator').innerHTML = months.map((m, i) => `
            <button onclick="loadMonth(${i})" class="nav-btn w-full text-left px-3 py-2 rounded-lg flex justify-between items-center text-sm text-slate-600 hover:bg-white hover:text-sky-600 transition-all">
                <span>${m}</span>
                <span class="text-[10px] bg-slate-100 px-2 py-0.5 rounded-full text-slate-500 font-medium w-6 text-center">${scheduleData[i].length}</span>
            </button>
        `).join('');

        loadMonth(0);

    </script>
</body>
</html>
